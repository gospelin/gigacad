"""Split Result into Result and StudentTermSummary

Revision ID: 2822e0b9b0ed
Revises: 435d83cce462
Create Date: 2025-03-16 10:09:51.431678

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision = '2822e0b9b0ed'
down_revision = '435d83cce462'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('student_term_summary',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('student_id', sa.Integer(), nullable=False),
    sa.Column('class_id', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.Integer(), nullable=False),
    sa.Column('term', sa.Enum('First', 'Second', 'Third', name='termenum'), nullable=False),
    sa.Column('grand_total', sa.Integer(), nullable=True),
    sa.Column('term_average', sa.Float(), nullable=True),
    sa.Column('cumulative_average', sa.Float(), nullable=True),
    sa.Column('last_term_average', sa.Float(), nullable=True),
    sa.Column('subjects_offered', sa.Integer(), nullable=True),
    sa.Column('position', sa.String(length=10), nullable=True),
    sa.Column('principal_remark', sa.String(length=100), nullable=True),
    sa.Column('teacher_remark', sa.String(length=100), nullable=True),
    sa.Column('next_term_begins', sa.String(length=100), nullable=True),
    sa.Column('date_issued', sa.String(length=100), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['class_id'], ['classes.id'], ),
    sa.ForeignKeyConstraint(['session_id'], ['session.id'], ),
    sa.ForeignKeyConstraint(['student_id'], ['student.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('student_id', 'class_id', 'term', 'session_id', name='unique_term_summary')
    )

    # Transfer data from result to student_term_summary (taking the latest remarks per group)
    op.execute("""
        INSERT INTO student_term_summary (
            student_id, class_id, session_id, term, grand_total, term_average, cumulative_average,
            last_term_average, subjects_offered, position, principal_remark, teacher_remark,
            next_term_begins, date_issued, created_at
        )
        SELECT
            student_id, class_id, session_id, term, grand_total, term_average, cumulative_average,
            last_term_average, subjects_offered, position, principal_remark, teacher_remark,
            next_term_begins, date_issued, created_at
        FROM (
            SELECT *,
                ROW_NUMBER() OVER (
                    PARTITION BY student_id, class_id, term, session_id
                    ORDER BY created_at DESC, id DESC
                ) as rn
            FROM result
            WHERE grand_total IS NOT NULL OR term_average IS NOT NULL
        ) t
        WHERE rn = 1;
    """)

    with op.batch_alter_table('result', schema=None) as batch_op:
        batch_op.drop_column('subjects_offered')
        batch_op.drop_column('date_issued')
        batch_op.drop_column('grand_total')
        batch_op.drop_column('teacher_remark')
        batch_op.drop_column('next_term_begins')
        batch_op.drop_column('principal_remark')
        batch_op.drop_column('term_average')
        batch_op.drop_column('position')
        batch_op.drop_column('last_term_average')
        batch_op.drop_column('cumulative_average')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('result', schema=None) as batch_op:
        batch_op.add_column(sa.Column('cumulative_average', mysql.FLOAT(), nullable=True))
        batch_op.add_column(sa.Column('last_term_average', mysql.FLOAT(), nullable=True))
        batch_op.add_column(sa.Column('position', mysql.VARCHAR(length=10), nullable=True))
        batch_op.add_column(sa.Column('term_average', mysql.FLOAT(), nullable=True))
        batch_op.add_column(sa.Column('principal_remark', mysql.VARCHAR(length=100), nullable=True))
        batch_op.add_column(sa.Column('next_term_begins', mysql.VARCHAR(length=100), nullable=True))
        batch_op.add_column(sa.Column('teacher_remark', mysql.VARCHAR(length=100), nullable=True))
        batch_op.add_column(sa.Column('grand_total', mysql.INTEGER(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('date_issued', mysql.VARCHAR(length=100), nullable=True))
        batch_op.add_column(sa.Column('subjects_offered', mysql.INTEGER(), autoincrement=False, nullable=True))

    op.drop_table('student_term_summary')
    # ### end Alembic commands ###
